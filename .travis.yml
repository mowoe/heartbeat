language: python
services:
  - docker
  - mysql



before_install:
  - mysql -e 'CREATE DATABASE heartbeat;'
  - mysql -e "CREATE USER 'heartbeat'@'%' IDENTIFIED BY 'heartbeat';"
  - mysql -e "GRANT ALL PRIVILEGES ON * . * TO 'heartbeat'@'%';"
  - docker build -t mowoe/heartbeat_ci .
  - docker run --network host --name heartbeat -d --hostname heartbeat -e DB_HOST=127.0.0.1 -e CELERY_QUEUE_NAME=$CELERY_QUEUE_NAME -e CELERY_QUEUE_URL=$CELERY_QUEUE_URL -e CELERY_AWS_SECRET=$CELERY_AWS_SECRET -e CELERY_AWS_KEY=$CELERY_AWS_KEY -e DB_PORT=3306 -e DB_PASSWORD=heartbeat -e DB_DATABASE=heartbeat -e DB_USER=heartbeat -e DB_TYPE=mysql -e OS_TYPE=local mowoe/heartbeat_ci
  - docker ps -a

install:
  - pip install requests pillow numpy
  - docker logs heartbeat

script: docker logs heartbeat -f & python tests/endpoint_test.py 

